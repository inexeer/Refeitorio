@model Refeitorio.Models.MenuWeek

@{
    ViewData["Title"] = "Menu Semanal";
    var selectedOption = (ViewBag.SelectedOption as string) ?? "Normal"; // Normal, Vegetariano ou All
    var weeks = ViewBag.Weeks as List<int> ?? new List<int>();
    var weekRanges = ViewBag.WeekRanges as Dictionary<int, string> ?? new Dictionary<int, string>();
    var currentRange = ViewBag.CurrentWeekRange as string ?? "";
    Layout = "../Shared/_LayoutNavbar.cshtml";
}

@if (TempData["Message"] != null)
{
    <div class="alert alert-info">@TempData["Message"]</div>
}
<!-- Selector de opção -->
<div class="mb-3">
    <a class="btn btn-outline-primary @(selectedOption == "Normal" ? "active" : "")"
        asp-controller="Menu" asp-action="Index" asp-route-week="@Model.WeekNumber" asp-route-option="Normal">Normal</a>

    <a class="btn btn-outline-primary @(selectedOption == "Vegetariano" ? "active" : "")"
        asp-controller="Menu" asp-action="Index" asp-route-week="@Model.WeekNumber" asp-route-option="Vegetariano">Vegetariano</a>

    <a class="btn btn-outline-secondary @(selectedOption == "All" ? "active" : "")"
        asp-controller="Menu" asp-action="Index" asp-route-week="@Model.WeekNumber" asp-route-option="All">Mostrar ambos</a>
</div>

<!-- Abas de semanas (preservam a opção selecionada) -->
<ul class="nav nav-tabs mb-3">
    @foreach (var w in weeks)
    {
        var active = w == Model.WeekNumber ? "active" : "";
        var label = weekRanges.ContainsKey(w) ? $"Semana {w} - {weekRanges[w]}" : $"Semana {w}";
        <li class="nav-item">
            <a class="nav-link @active" asp-controller="Menu" asp-action="Index" asp-route-week="@w" asp-route-option="@selectedOption">@label</a>
        </li>
    }
</ul>

<div class="row">
    @* Agrupar por dia (weekday+date) para mostrar Normal/Vegetariano juntos quando "All" *@
    @foreach (var dayGroup in Model.MenuDays.GroupBy(d => new { d.Weekday, d.Date }).Select(g => g.ToList()))
    {
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">@dayGroup.First().Weekday - @dayGroup.First().Date.ToString("dd/MM/yyyy")</h5>

                    @foreach (var opt in dayGroup)
                    {
                        <div class="mb-2">
                            <strong>(@opt.Option)</strong>
                            <p class="mb-0">@opt.MainDish</p>
                            <p class="mb-0">Sopa: @opt.Soup</p>
                            <p class="mb-1">Doce: @opt.Dessert</p>

                            <form asp-controller="Menu" asp-action="Book" method="post" class="d-inline">
                                <input type="hidden" name="dayId" value="@opt.Id" />
                                <input type="hidden" name="weekNumber" value="@Model.WeekNumber" />
                                <input type="hidden" name="option" value="@opt.Option" />
                                @* preservar a opção que estava seleccionada ("All" ou "Normal") para redirecionar corretamente *@
                                <input type="hidden" name="returnOption" value="@selectedOption" />
                                <button class="btn btn-primary btn-sm" type="submit">Marcar almoço</button>
                            </form>
                        </div>
                        <hr />
                    }
                </div>
            </div>
        </div>
    }
</div>
